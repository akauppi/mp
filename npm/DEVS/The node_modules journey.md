# The `node_modules` <strike>dilemma</strike> journey...

## Problem

Multipass mounts (as of 1.15.1 and quite some time before) have a problem with large folders with lots of (small) files.

The way the author eradicates this problem in Rust is by pointing the dependencies and build artifacts to live on the local VM filesystem, instead of the shared mount. Cargo can use a `target-dir = ...` config for this.

No such "luck" with `npm`.


## World view of `npm`

Whereas `node` can be told where its dependencies are (by `NODE_PATH` env.var), `npm` does not follow this. 

- it *does* have a "global mode", but that's a) meant for other kind of use, b) didn't fare well as a work-around
- it *does* have "workspaces", but a) the author wasn't familiar with them (lame reason) and b) they aim to solve a different problem, not that of directing separate projects' dependencies to a global place

Cut the story short, there emerged a workable solution!

## Fast track to solution

Within the VM, *replace* the (mounted) `node_modules` folder by *another mount*, within the VM, this time. See here:

```
$ sudo mount -t tmpfs -o size=500m,uid=1000 abc node_modules
```

```
$ mkdir ../node_modules.ABC
$ sudo mount --bind ../node_modules.ABC node_modules
```

The first one uses `tmpfs`, making a memory partition. It's fast, but the changes (`npm install`) don't survive over a VM restart.

The second one is equally performant, and the changes remain in place.

>Note: However, as we'll mention below, the *mount* does not survive over a VM restart.


## The aims of the author

I'd like to ignore this problem.

In particular, I'd like the version controlled files *not* to reflect there is a problem.

This means, if you're developing the code on, say, a native Linux account, you shouldn't see clutter due to some Multipass-on-Mac-only issue.

Furthermore, if you weren't reading this text, things would still *work*, they just work really, really slow.


## Things considered

### Symbolic link of `node_modules`

Nope. `npm` observes it, prints out "non-directory blah-blah replaced", and carries on with the link gone and a local `node_modules` folder created (which is slow).

That's *one* way to deal with it.


### Alternative package managers...?

Yeah, I gave `pnpm` a try. Just... don't really like it enough. And there's nothing *really* wrong with `npm`.

So uninstalled it. But if you like `pnpm`, you're likely to not have this whole problem, at all.


## Positive side effects

Having `node_module` carry different contents for your (host side) IDE and the VM is a Good Thing. It avoids the stepping-on-toes of binary modules, where the IDE could install a macOS variant that the Linux-side VM then dislikes. For each, their own.
